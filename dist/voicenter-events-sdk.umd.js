!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("socket.io-client/socket.io")):"function"==typeof define&&define.amd?define(["socket.io-client/socket.io"],t):(e=e||self).VoicenterEventsSDK=t(e.io)}(this,function(e){"use strict";function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function o(e,t,o){return t&&n(e.prototype,t),o&&n(e,o),e}e=e&&e.hasOwnProperty("default")?e.default:e;var i={LOGIN:"loginStatus",LOGIN_RESPONSE:"loginResponse",QUEUE_EVENT:"QueueEvent",EXTENSION_EVENT:"ExtensionEvent",ALL_EXTENSION_STATUS:"AllExtensionsStatus",CONNECT_ERROR:"connect_error",CONNECT_TIMEOUT:"connect_timeout",DISCONNECT:"disconnect",RECONNECT:"reconnect",RECONNECT_ATTEMPT:"reconnect_attempt",RECONNECTING:"reconnecting",RECONNECT_ERROR:"reconnect_error",RECONNECT_FAILED:"reconnect_failed",KEEP_ALIVE:"keepalive",KEEP_ALIVE_RESPONSE:"keepaliveResponse",CLOSE:"closeme",SERVER_FETCH_ERROR:"server_fetch_error",ERROR:"error"},r=[{URLID:59,Priority:5,Version:2,Domain:"monitor1.voicenter.co"},{URLID:3,Priority:4,Version:2,Domain:"monitor3.voicenter.co.il"},{URLID:4,Priority:3,Version:2,Domain:"monitor4.voicenter.co.il"},{URLID:11,Priority:2,Version:2,Domain:"monitor11.voicenter.co"},{URLID:5,Priority:0,Version:2,Domain:"monitor5.voicenter.co.il"}],s=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t(this,e),this.debug=n.debug}return o(e,[{key:"_log",value:function(e,t){var n=t?"".concat(e,", %c Data -> ").concat(JSON.stringify(t)):"".concat(e),o=(new Date).toUTCString();console.log("%c ".concat(o,": %c ").concat(n),"color: #276749;","color: #4299e1;","color: #2c3e50;")}},{key:"_error",value:function(e,t){var n=t?"".concat(e,", Data -> ").concat(JSON.stringify(t)):"".concat(e),o=(new Date).toUTCString();console.error("".concat(o,": ").concat(n))}},{key:"log",value:function(e,t){this.debug&&(e&&!t?this._log(e):this._log(e,t))}},{key:"error",value:function(e,t){this.debug&&(e&&!t?this._error(e):this._error(e,t))}}]),e}();var c=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)},a="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},l="object"==typeof a&&a&&a.Object===Object&&a,h="object"==typeof self&&self&&self.Object===Object&&self,u=l||h||Function("return this")(),v=function(){return u.Date.now()},f=u.Symbol,y=Object.prototype,p=y.hasOwnProperty,E=y.toString,d=f?f.toStringTag:void 0;var g=function(e){var t=p.call(e,d),n=e[d];try{e[d]=void 0;var o=!0}catch(e){}var i=E.call(e);return o&&(t?e[d]=n:delete e[d]),i},_=Object.prototype.toString;var k=function(e){return _.call(e)},C="[object Null]",O="[object Undefined]",R=f?f.toStringTag:void 0;var T=function(e){return null==e?void 0===e?O:C:R&&R in Object(e)?g(e):k(e)};var m=function(e){return null!=e&&"object"==typeof e},N="[object Symbol]";var b=function(e){return"symbol"==typeof e||m(e)&&T(e)==N},D=NaN,S=/^\s+|\s+$/g,w=/^[-+]0x[0-9a-f]+$/i,L=/^0b[01]+$/i,A=/^0o[0-7]+$/i,I=parseInt;var P=function(e){if("number"==typeof e)return e;if(b(e))return D;if(c(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=c(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(S,"");var n=L.test(e);return n||A.test(e)?I(e.slice(2),n?2:8):w.test(e)?D:+e},x="Expected a function",M=Math.max,j=Math.min;var F=function(e,t,n){var o,i,r,s,a,l,h=0,u=!1,f=!1,y=!0;if("function"!=typeof e)throw new TypeError(x);function p(t){var n=o,r=i;return o=i=void 0,h=t,s=e.apply(r,n)}function E(e){var n=e-l;return void 0===l||n>=t||n<0||f&&e-h>=r}function d(){var e=v();if(E(e))return g(e);a=setTimeout(d,function(e){var n=t-(e-l);return f?j(n,r-(e-h)):n}(e))}function g(e){return a=void 0,y&&o?p(e):(o=i=void 0,s)}function _(){var e=v(),n=E(e);if(o=arguments,i=this,l=e,n){if(void 0===a)return function(e){return h=e,a=setTimeout(d,t),u?p(e):s}(l);if(f)return clearTimeout(a),a=setTimeout(d,t),p(l)}return void 0===a&&(a=setTimeout(d,t)),s}return t=P(t)||0,c(n)&&(u=!!n.leading,r=(f="maxWait"in n)?M(P(n.maxWait)||0,t):r,y="trailing"in n?!!n.trailing:y),_.cancel=function(){void 0!==a&&clearTimeout(a),h=0,o=l=i=a=void 0},_.flush=function(){return void 0===a?s:g(v())},_};var U={url:"https://monitorapi.voicenter.co.il/monitorAPI/getMonitorUrls",servers:r,token:null,forceNew:!1,reconnectionDelay:1e4,reconnectionDelayMax:1e4,timeout:1e4,keepAliveTimeout:6e4,protocol:"https",transports:["websocket"],upgrade:!1,serverType:null},V=[],K=new Map,G=function(){function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(t(this,n),this.options=Object.assign({},U,{},e),!this.options.token)throw new Error("A token property should be provided");this.Logger=new s(this.options),this.servers=[],this.server=null,this.socket=null,this.connected=!1,this.connectionEstablished=!1,this.shouldReconnect=!0,this._initReconnectOptions(),this._listenersMap=K,this._retryConnection=F(this._connect.bind(this),this.reconnectOptions.reconnectionDelay,{leading:!0,trailing:!1})}return o(n,[{key:"_initReconnectOptions",value:function(){this.reconnectOptions={retryCount:1,reconnectionDelay:this.options.reconnectionDelay,minReconnectionDelay:this.options.reconnectionDelay,maxReconnectionDelay:3e5}}},{key:"_onConnect",value:function(){this.onConnect&&this.onConnect(0,"OK"),this._initReconnectDelays(),this.connected=!0,this.Logger.log(i.CONNECT,this.reconnectOptions)}},{key:"_initReconnectDelays",value:function(){this.reconnectOptions.retryCount=1;var e=this.reconnectOptions.minReconnectionDelay;this.reconnectOptions.reconnectionDelay=e,this.socket.io.reconnectionDelay(e),this.socket.io.reconnectionDelayMax(e)}},{key:"_onConnectError",value:function(e){this.onConnectError&&this.onConnectError(e),this._retryConnection("next"),this.connected=!1,this.Logger.log(i.CONNECT_ERROR,e)}},{key:"_onError",value:function(e){this.onError&&this.onError(data),this.Logger.log(i.ERROR,data)}},{key:"_onReconnectFailed",value:function(){this.onReconnectFailed&&this.onReconnectFailed(),this._retryConnection("next"),this.Logger.log(i.RECONNECT_FAILED,this.reconnectOptions)}},{key:"_onConnectTimeout",value:function(){this.onConnectTimeout&&this.onConnectTimeout(),this._retryConnection("next"),this.Logger.log(i.CONNECT_TIMEOUT,this.reconnectOptions)}},{key:"_onReconnectAttempt",value:function(e){if(this.onReconnectAttempt&&this.onReconnectAttempt(e),e>2)this._retryConnection("next");else{if(this.reconnectOptions.reconnectionDelay<this.reconnectOptions.maxReconnectionDelay){var t=this.reconnectOptions.minReconnectionDelay*this.reconnectOptions.retryCount;this.reconnectOptions.reconnectionDelay=t,this.socket.io.reconnectionDelay(t),this.socket.io.reconnectionDelayMax(t)}this.reconnectOptions.retryCount++,this.Logger.log(i.RECONNECT_ATTEMPT,this.reconnectOptions)}}},{key:"_onDisconnect",value:function(e){this.onDisconnect&&this.onDisconnect(e),this.shouldReconnect&&this._connect("next"),this.connected=!1,this.Logger.log(i.DISCONNECT,this.reconnectOptions)}},{key:"_onKeepAlive",value:function(e){this.onKeepAlive&&this.onKeepAlive(e),!1===e&&this.connected&&(this._initSocketConnection(),this.Logger.log(i.KEEP_ALIVE_RESPONSE,this.reconnectOptions))}},{key:"_parsePacket",value:function(e){return e.data?{name:e.data[0],data:e.data[1]}:{}}},{key:"_connect",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"default";this.shouldReconnect=!0;var t=null;if("default"===e)t=this._findCurrentServer();else if("next"===e)t=this._findNextAvailableServer();else{if("prev"!==e)throw new Error("Incorrect 'server' parameter passed to connect function ".concat(e,". Should be 'default' or 'next'"));t=this._findMaxPriorityServer()}t&&(this._initSocketConnection(),this._initSocketEvents(),this._initKeepAlive(),"default"!==e&&this.login())}},{key:"_checkInit",value:function(){if(!this.connectionEstablished)throw new Error('Make sure you call "sdk.init()" before doing other operations.')}},{key:"_initSocketConnection",value:function(){var t=this.server.Domain,n=this.options.protocol,o="".concat(n,"://").concat(t);this.Logger.log("Connecting to..",o),this.closeAllConnections(),this.socket=e(o,Object.assign({},this.options,{debug:!1})),V.push(this.socket),this.connectionEstablished=!0}},{key:"_initSocketEvents",value:function(){this.socket.on(i.RECONNECT_ATTEMPT,this._onReconnectAttempt.bind(this)),this.socket.on(i.RECONNECT_FAILED,this._onReconnectFailed.bind(this)),this.socket.on(i.CONNECT,this._onConnect.bind(this)),this.socket.on(i.DISCONNECT,this._onDisconnect.bind(this)),this.socket.on(i.ERROR,this._onError.bind(this)),this.socket.on(i.CONNECT_ERROR,this._onConnectError.bind(this)),this.socket.on(i.CONNECT_TIMEOUT,this._onConnectTimeout.bind(this)),this.socket.on(i.KEEP_ALIVE_RESPONSE,this._onKeepAlive.bind(this)),this.socket.onevent=this._onEvent.bind(this)}},{key:"_initKeepAlive",value:function(){var e=this;setTimeout(function(){e.socket?(e.emit(i.KEEP_ALIVE,e.options.token),e._connect("prev")):e._initSocketConnection()},this.options.keepAliveTimeout)}},{key:"_findCurrentServer",value:function(){var e=null;if(this.servers.length&&(e=this.servers[0]),this.server=e,!this.server)throw new Error("Could not find any server to establish connection with");return this.server}},{key:"_findNextAvailableServer",value:function(){var e=this.server.Priority;if(this.Logger.log("Failover -> Trying to find another server"),e>0){var t=e-1,n=this.servers.find(function(e){return e.Priority===t});if(!n&&!(n=this._findMaxPriorityServer()))return;if(this.server.Domain!==n.Domain)return this.server=n,this.server;this.Logger.log("Failover -> Found new server. Connecting to it...",this.server)}return null}},{key:"_findMaxPriorityServer",value:function(){this.Logger.log("Fallback -> Trying to find previous server","_findMaxPriorityServer");var e,t,n,o=(e=this.servers,t=null,n=-1,e.forEach(function(e){e.Priority>n&&(n=e.Priority,t=e)}),t);return this.server&&o.Domain!==this.server.Domain?(this.server=o,this.Logger.log("Fallback -> Trying to find previous server",this.server),this.server):null}},{key:"_getServers",value:async function(){if(this.options.servers&&Array.isArray(this.options.servers)&&this.options.servers.length>1)this.servers=this.options.servers;else try{var e={};this.options.serverType&&(e.type=this.options.serverType);var t=await fetch("".concat(this.options.url,"/").concat(this.options.token),e);this.servers=await t.json()}catch(e){this.servers=this.options.servers||r,this.emit(i.SERVER_FETCH_ERROR)}}},{key:"_onEvent",value:function(e){if(e.data){var t=this._parsePacket(e);this.Logger.log("New event -> ".concat(t.name),t),this._listenersMap.forEach(function(e,n){"*"===n?e(t):t.name===n&&e(t)})}}},{key:"init",value:async function(){return!!this.connectionEstablished||(this.socket&&this.emit(i.CLOSE),await this._getServers(),this._connect(),this._initReconnectDelays(),!0)}},{key:"setToken",value:function(e){this.options.token=e}},{key:"closeAllConnections",value:function(){V.forEach(function(e){e.close()}),V=[]}},{key:"disconnect",value:function(){this.shouldReconnect=!1,this._listenersMap=new Map,this.closeAllConnections()}},{key:"on",value:function(e,t){this._listenersMap.set(e,t),this._checkInit()}},{key:"emit",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this._checkInit(),this.Logger.log("EMIT -> ".concat(e),t),this.socket.emit(e,t)}},{key:"login",value:function(){var e=this,t=this;return this._checkInit(),new Promise(function(n,o){e.on(i.LOGIN,function(e){t.onLogin&&t.onLogin(e),n(e)}),e.emit("login",{token:e.options.token})})}}]),n}();return"undefined"!=typeof window&&(window.EventsSDK=G),G});
//# sourceMappingURL=voicenter-events-sdk.umd.js.map
